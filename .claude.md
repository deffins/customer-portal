# Customer Portal WordPress Plugin - Development Guide

## Project Overview
WordPress plugin for customer portal management with Telegram authentication, Google Calendar/Drive integration, and survey functionality.

**Repository:** c:\projects\customer-portal\
**Production Site:** deffo.pro (main branch)
**Test Site:** fons.lv (test branch)

## Environment Setup

### Two-Environment Architecture
This project uses a two-site setup with separate domains:

| Environment | Domain | Git Branch | Deploy Target |
|-------------|--------|------------|---------------|
| **Production** | deffo.pro | `main` | `/domains/deffo.pro/public_html/wp-content/plugins/customer-portal/` |
| **Test** | fons.lv | `test` | `/domains/fons.lv/public_html/wp-content/plugins/customer-portal/` |

### Key Characteristics
- **Separate WordPress installations** - Each domain has its own WP install and database
- **Separate databases** - No shared data between environments
- **Branch-based deployment** - GitHub Actions auto-deploy on push
- **Environment-specific configs** - Telegram bots differ per environment via wp-config.php constants

### Deployment Workflow
```
Push to test branch → GitHub Actions → FTP to fons.lv
     ↓
  Test & verify
     ↓
Merge test → main → GitHub Actions → FTP to deffo.pro
```

## Configuration Management

### Telegram Bot Configuration (Environment-Specific)
**Storage:** wp-config.php constants (one for each environment, NOT in git)

**Production (deffo.pro):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'production-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'prod_bot_username');
```

**Test (fons.lv):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'test-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'test_bot_username');
```

**Fallback:** If constants not defined, plugin uses WordPress options table (`cp_telegram_bot_token`, `cp_telegram_bot_username`)

**Why this works:**
- wp-config.php is NOT in git (each site has its own)
- Same plugin code on both sites
- Each site reads its own wp-config.php constants
- Pushing test → main does NOT affect bot configuration

### Google Calendar/Drive Configuration (Same on Both)
**Storage:** WordPress options table only (no environment differentiation needed)

- `cp_google_client_id`
- `cp_google_client_secret`
- `cp_google_refresh_token`

These credentials are the **same** on both deffo.pro and fons.lv.

## Plugin Architecture

### Core Files
```
customer-portal/
├── customer-portal.php          # Main plugin file, registers hooks
├── includes/
│   ├── class-portal-database.php    # Database schema, table creation
│   ├── class-portal-admin.php       # Admin settings page
│   ├── class-portal-ajax.php        # AJAX handlers (Telegram auth, user CRUD)
│   ├── class-portal-frontend.php    # Frontend shortcode [customer_portal]
│   └── class-portal-surveys.php     # Survey functionality
├── assets/
│   ├── js/
│   │   ├── portal.js            # Main frontend JS (Telegram widget, user list)
│   │   ├── calendar.js          # Google Calendar integration
│   │   └── surveys.js           # Survey UI
│   └── css/
│       └── portal.css           # Frontend styles
├── .github/workflows/
│   ├── deploy.yml               # Auto-deploy main → deffo.pro
│   └── deploy-test.yml          # Auto-deploy test → fons.lv
└── docs/
    ├── TWO-DOMAIN-SETUP.md      # Environment setup guide
    ├── DEPLOYMENT.md            # FTP deployment instructions
    └── TROUBLESHOOTING.md       # Common issues
```

### Database Schema

**Table:** `wp_customer_portal_users`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, unique) - Primary user identifier
- first_name (varchar 255)
- last_name (varchar 255)
- username (varchar 255)
- email (varchar 255)
- drive_folder_id (varchar 255) - Google Drive folder for user
- is_active (tinyint) - User status
- created_at (datetime)
```

**Table:** `wp_customer_portal_surveys`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, foreign key to users)
- survey_data (longtext, JSON)
- created_at (datetime)
- updated_at (datetime)
```

### Authentication Flow

1. User visits customer portal page (shortcode `[customer_portal]`)
2. Telegram Login Widget displays (uses `cp_telegram_bot_username`)
3. User authenticates via Telegram
4. Telegram sends auth data to frontend
5. Frontend AJAX call to `verify_telegram_auth` action
6. Backend validates HMAC signature using `cp_telegram_bot_token`
7. User created/updated in database (by `telegram_id`)
8. Session established, user list loads

**Key Files:**
- [includes/class-portal-frontend.php:70](c:\projects\customer-portal\includes\class-portal-frontend.php#L70) - Passes bot username to JS
- [includes/class-portal-ajax.php:57-133](c:\projects\customer-portal\includes\class-portal-ajax.php#L57-L133) - HMAC validation logic

### Google Integration Flow

**Google Calendar:**
1. Admin configures Google credentials in settings
2. Users can book appointments via calendar.js
3. Events created in Google Calendar with Meet links
4. Calendar invites sent to customer email

**Google Drive:**
1. Each user gets a dedicated Drive folder (`drive_folder_id`)
2. Folder created on first access
3. Used for storing customer documents

## Development Workflow

### Making Changes
1. **Always work on `test` branch first**
2. Push to test → auto-deploys to fons.lv
3. Test thoroughly on fons.lv
4. Merge test → main → auto-deploys to deffo.pro

### Testing Checklist
- [ ] Telegram authentication works (test bot on fons.lv)
- [ ] User CRUD operations function
- [ ] Google Calendar integration works
- [ ] Survey functionality works
- [ ] Admin settings page displays correctly
- [ ] No console errors in browser
- [ ] No PHP errors in WordPress debug log

### Important Notes
- **Never commit wp-config.php** (already in .gitignore)
- **Never commit .env files** (if created in future)
- **Telegram bot tokens are sensitive** - keep in wp-config.php only
- **Same code, different configs** - Environment differences handled by wp-config.php

## Common Tasks

### Adding a New Feature
1. Develop on test branch
2. Test on fons.lv with test Telegram bot
3. Merge to main
4. Verify on deffo.pro with production Telegram bot

### Updating Telegram Bot (Per Environment)
1. SSH or File Manager on the specific site
2. Edit wp-config.php
3. Update `CP_TELEGRAM_BOT_TOKEN` or `CP_TELEGRAM_BOT_USERNAME`
4. Save file (no code deployment needed)

### Debugging
- Check browser console for JavaScript errors
- Check WordPress debug.log for PHP errors
- Verify Telegram bot token is correct for environment
- Check GitHub Actions logs for deployment issues

## Security Considerations
- Telegram bot tokens in wp-config.php (not database)
- HMAC signature validation for Telegram auth
- Nonce verification for AJAX requests
- Input sanitization with `sanitize_text_field()`
- SQL injection prevention with `$wpdb->prepare()`
- Hash timing-safe comparison with `hash_equals()`

## Future Enhancements
(To be added as development continues)
