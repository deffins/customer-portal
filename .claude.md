# Customer Portal WordPress Plugin - Development Guide

## Project Overview
WordPress plugin for customer portal management with Telegram authentication, Google Calendar/Drive integration, and survey functionality.

**Repository:** c:\projects\customer-portal\
**Production Site:** deffo.pro (main branch)
**Test Site:** fons.lv (test branch)

## Environment Setup

### Two-Environment Architecture
This project uses a two-site setup with separate domains:

| Environment | Domain | Git Branch | Deploy Target |
|-------------|--------|------------|---------------|
| **Production** | deffo.pro | `main` | `/domains/deffo.pro/public_html/wp-content/plugins/customer-portal/` |
| **Test** | fons.lv | `test` | `/domains/fons.lv/public_html/wp-content/plugins/customer-portal/` |

### Key Characteristics
- **Separate WordPress installations** - Each domain has its own WP install and database
- **Separate databases** - No shared data between environments
- **Branch-based deployment** - GitHub Actions auto-deploy on push
- **Environment-specific configs** - Telegram bots differ per environment via wp-config.php constants

### Deployment Workflow
```
Push to test branch → GitHub Actions → FTP to fons.lv
     ↓
  Test & verify
     ↓
Merge test → main → GitHub Actions → FTP to deffo.pro
```

## Configuration Management

### Telegram Bot Configuration (Environment-Specific)
**Storage:** wp-config.php constants (one for each environment, NOT in git)

**Production (deffo.pro):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'production-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'prod_bot_username');
```

**Test (fons.lv):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'test-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'test_bot_username');
```

**Fallback:** If constants not defined, plugin uses WordPress options table (`cp_telegram_bot_token`, `cp_telegram_bot_username`)

**Why this works:**
- wp-config.php is NOT in git (each site has its own)
- Same plugin code on both sites
- Each site reads its own wp-config.php constants
- Pushing test → main does NOT affect bot configuration

### Google Calendar/Drive Configuration
**Storage:** WordPress options table only (no environment differentiation needed)

- `cp_google_client_id`
- `cp_google_client_secret`
- `cp_google_refresh_token`

**Current Setup:**
- **OAuth App:** "Customer Portal Helper" (Desktop app) in Google Cloud Console
- **Test Environment (fons.lv):** Credentials configured and working
- **Production Environment (deffo.pro):** Needs credentials update when deploying to production

**Important for OAuth App Longevity:**
1. **Publish OAuth app to Production mode** (not "Testing") to prevent refresh token expiration after 7 days
2. Go to: [OAuth Consent Screen](https://console.cloud.google.com/apis/credentials/consent)
3. If status shows "Testing" → Click "PUBLISH APP"
4. In Production mode, refresh tokens never expire unless manually revoked

**OAuth App Details:**
- **Type:** Desktop app (not Web app)
- **Name:** Customer Portal Helper
- **Redirect URI:** `http://localhost`
- **Scopes:** Calendar, Calendar Events, Drive (read-only)

**Getting a New Refresh Token:**
- Use `google-auth-helper.html` in project root
- Desktop app credentials work with `http://localhost` redirect
- Old `urn:ietf:wg:oauth:2.0:oob` redirect is deprecated and will fail
- Delete helper files after getting token (they contain credentials)

## Plugin Architecture

### Core Files
```
customer-portal/
├── customer-portal.php          # Main plugin file, registers hooks
├── includes/
│   ├── class-portal-database.php    # Database schema, table creation
│   ├── class-portal-admin.php       # Admin settings page
│   ├── class-portal-ajax.php        # AJAX handlers (Telegram auth, user CRUD)
│   ├── class-portal-frontend.php    # Frontend shortcode [customer_portal]
│   └── class-portal-surveys.php     # Survey functionality
├── assets/
│   ├── js/
│   │   ├── portal.js            # Main frontend JS (Telegram widget, user list)
│   │   ├── calendar.js          # Google Calendar integration
│   │   └── surveys.js           # Survey UI
│   └── css/
│       └── portal.css           # Frontend styles
├── .github/workflows/
│   ├── deploy.yml               # Auto-deploy main → deffo.pro
│   └── deploy-test.yml          # Auto-deploy test → fons.lv
└── docs/
    ├── TWO-DOMAIN-SETUP.md      # Environment setup guide
    ├── DEPLOYMENT.md            # FTP deployment instructions
    └── TROUBLESHOOTING.md       # Common issues
```

### Database Schema

**Table:** `wp_customer_portal_users`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, unique) - Primary user identifier
- first_name (varchar 255)
- last_name (varchar 255)
- username (varchar 255)
- email (varchar 255)
- drive_folder_id (varchar 255) - Google Drive folder for user
- is_active (tinyint) - User status
- created_at (datetime)
```

**Table:** `wp_customer_portal_surveys`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, foreign key to users)
- survey_data (longtext, JSON)
- created_at (datetime)
- updated_at (datetime)
```

### Authentication Flow

1. User visits customer portal page (shortcode `[customer_portal]`)
2. Telegram Login Widget displays (uses `cp_telegram_bot_username`)
3. User authenticates via Telegram
4. Telegram sends auth data to frontend
5. Frontend AJAX call to `verify_telegram_auth` action
6. Backend validates HMAC signature using `cp_telegram_bot_token`
7. User created/updated in database (by `telegram_id`)
8. Session established, user list loads

**Key Files:**
- [includes/class-portal-frontend.php:70](c:\projects\customer-portal\includes\class-portal-frontend.php#L70) - Passes bot username to JS
- [includes/class-portal-ajax.php:57-133](c:\projects\customer-portal\includes\class-portal-ajax.php#L57-L133) - HMAC validation logic

### Google Integration Flow

**Google Calendar:**
1. Admin configures Google credentials in settings
2. Users can book appointments via calendar.js
3. Events created in Google Calendar with Meet links
4. Calendar invites sent to customer email

**Google Drive:**
1. Each user gets a dedicated Drive folder (`drive_folder_id`)
2. Folder created on first access
3. Used for storing customer documents

### Survey System Architecture

The plugin supports two types of surveys with different purposes and workflows:

#### 1. Wizard Surveys (JSON-based, hardcoded)
**Purpose:** Multi-question surveys with scoring and dimension analysis (e.g., liver health assessment)

**Storage:**
- Survey definitions: Hardcoded in PHP (see `cp_get_survey_definition` in class-portal-ajax.php)
- User results: `wp_cp_survey_results` table
- Assignments: `wp_cp_survey_assignments` table

**Structure:**
```json
{
  "id": "liver_health_short",
  "title": "Aknu veselības anketa (īsa versija)",
  "description": "Īsa anketa par aknu, žults, gremošanas un stresa simptomiem.",
  "questions": [
    {
      "id": "q1",
      "label": "Question text",
      "type": "slider|single_choice|text",
      "min": 0, "max": 10,  // for slider
      "options": [...],      // for single_choice
      "dimension": "liver|bile|digestion|stress"
    }
  ]
}
```

**Workflow:**
1. Admin assigns survey to user via Assignments dropdown
2. User sees survey card in Surveys tab with "Start Survey" button
3. Survey opens in wizard mode (one question at a time)
4. Progress bar shows completion percentage
5. Answers stored in JSON format with dimension scores
6. Survey can be retaken (completion_count tracked)

**Key Files:**
- [includes/class-portal-ajax.php:400-535](includes/class-portal-ajax.php#L400-L535) - Survey definitions and AJAX handlers
- [assets/js/surveys.js](assets/js/surveys.js) - Wizard UI rendering
- [includes/class-portal-database.php:669-735](includes/class-portal-database.php#L669-L735) - Assignment methods

#### 2. Supplement Feedback Surveys V2 (Mobile-first + Append Notes)
**Purpose:** Collect free-form, human-written supplement experience notes per user per supplement, optimized for later export to LLM analysis (not for strict numeric/medical validation)

**Core Principles:**
- Mobile-first UX with "one primary focus screen"
- Free-form text only (no required fields, no unit validation)
- Users may skip any supplement
- Data is append-only (multiple notes over time); never overwrite history
- Survey "Finish/Submit" means notify admin / mark as submitted, not "all supplements completed"

**Storage Architecture (V2):**

The supplement survey system uses a normalized database structure with append-only notes:

1. **Survey Metadata** (`wp_cp_surveys`) — unchanged
   - Fields: `id`, `title`, `type` (always 'supplement_feedback'), `created_at`, `updated_at`
   - One record per survey (e.g., "New sup survey")

2. **Supplements List** (`wp_cp_survey_supplements`) — extended with optional admin context
   - Fields: `id`, `survey_id` (FK), `name` (supplement name), `sort_order`
   - **NEW:** `admin_context` (text, nullable) — read-only context shown to client (e.g., "2 kapsulas dienā / tējkarote / sauja")
   - Multiple records per survey (one per supplement)

3. **User Notes - Append-only** (`wp_cp_survey_supplement_notes`) — NEW (replaces V1 comments table)
   - Stores chronological, append-only notes (no editing/deletion of old notes)
   - Fields:
     - `id` (PK)
     - `survey_id` (int, denormalized for query performance)
     - `supplement_id` (FK → wp_cp_survey_supplements.id)
     - `user_id` (FK → wp_customer_portal_users.id)
     - `note_text` (text, nullable but typically non-empty)
     - `note_type` (varchar 20, default 'note') — values: 'note' | 'followup'
     - `created_at`, `updated_at`
   - Indexes:
     - `INDEX user_supplement_time (user_id, supplement_id, created_at)`
     - `INDEX survey_user (survey_id, user_id)`
   - **Important:** V2 removes the "one comment per user per supplement" limitation. Notes are historical and chronological.

4. **Survey Assignments** (`wp_cp_survey_assignments`) — status expanded
   - Fields: `user_id`, `survey_id` (format: "supplement_3"), `status`, `created_at`, `updated_at`
   - **Status values (V2):**
     - `assigned` — survey assigned, no activity yet
     - `in_progress` — auto-set when first note is created
     - `submitted` — user pressed "Finish & notify"
   - `UNIQUE KEY user_survey (user_id, survey_id)`

**Database Schema (V2):**
```sql
wp_cp_surveys: (unchanged)
- id (PK)
- title (varchar 255)
- type ('supplement_feedback')
- created_at, updated_at

wp_cp_survey_supplements: (extended)
- id (PK)
- survey_id (FK → wp_cp_surveys.id)
- name (varchar 255, supplement name)
- sort_order (int, display order)
- admin_context (text, nullable) -- NEW: optional dosage/usage context

wp_cp_survey_supplement_notes: (NEW - replaces comments)
- id (PK)
- survey_id (int, denormalized)
- supplement_id (FK → wp_cp_survey_supplements.id)
- user_id (FK → wp_customer_portal_users.id)
- note_text (text, nullable)
- note_type (varchar 20, default 'note') -- 'note' | 'followup'
- created_at, updated_at
- INDEX user_supplement_time (user_id, supplement_id, created_at)
- INDEX survey_user (survey_id, user_id)

wp_cp_survey_assignments: (status expanded)
- id (PK)
- user_id (FK → wp_customer_portal_users.id)
- survey_id (varchar 100, format: "supplement_3")
- status (varchar 50) -- 'assigned' | 'in_progress' | 'submitted'
- created_at, updated_at
- UNIQUE KEY user_survey (user_id, survey_id)
```

**Migration Notes (V1 → V2):**
- Legacy table `wp_cp_survey_supplement_comments` (V1) with UNIQUE constraint should be migrated:
  - For each existing comment: INSERT one row into `wp_cp_survey_supplement_notes` with `note_type='note'`
  - Preserve timestamps: use old `updated_at` or `created_at` for migration
  - After migration, V1 table can be deprecated (keep temporarily for rollback safety)

**Data Flow & Write Operations (V2):**

1. **Admin Creates Survey** (extended)
   - Admin panel: "Supplement Feedback Surveys" section
   - Admin enters survey title and adds supplements
   - **NEW:** Admin can optionally add `admin_context` per supplement (e.g., "2 kapsulas dienā")
   - **Database writes:**
     - `INSERT INTO wp_cp_surveys (title, type='supplement_feedback')`
     - Multiple `INSERT INTO wp_cp_survey_supplements (survey_id, name, sort_order, admin_context)`

2. **Admin Assigns Survey to User** (unchanged)
   - `INSERT INTO wp_cp_survey_assignments (user_id, survey_id='supplement_3', status='assigned')`

3. **Client Adds a Note** (append-only)
   - User writes free-form text in Product Detail View
   - Autosave triggers on blur/typing (debounced)
   - User presses "Save and next" or "Skip and next"
   - **AJAX call:** `cp_add_supplement_note` (survey_id, supplement_id, telegram_id, note_text, note_type='note')
   - **Database write:**
     - `INSERT INTO wp_cp_survey_supplement_notes (survey_id, supplement_id, user_id, note_text, note_type)`
     - After first note: `UPDATE wp_cp_survey_assignments SET status='in_progress'` (auto)

4. **Client Adds Follow-up Note** (append-only)
   - Optional UI: "Add follow-up note" button
   - Same endpoint: `cp_add_supplement_note` with `note_type='followup'`
   - **Database write:** `INSERT` (append-only, does not update existing notes)

5. **Client Submits Survey**
   - User presses "Finish & notify" button in list view
   - **AJAX call:** `cp_submit_supplement_survey` (telegram_id, survey_id)
   - **Database write:** `UPDATE wp_cp_survey_assignments SET status='submitted'`
   - Future: trigger admin notification

**Note:** Deleting notes is not supported in V2 (append-only design). If deletion is needed later, implement soft-delete via `deleted_at` field.

**Client-Side UI Design & Behavior (V2 - Mobile-first):**

**A) Entry: Surveys Tab** (unchanged)
- Survey cards mixed with wizard surveys
- Clicking "Start Survey" → routes to Supplement Survey List View

**B) Supplement Survey List View** (NEW default view)
- Shows all supplements with completion indicators
- Each supplement row/card displays:
  - Supplement name
  - Optional last note preview (first line truncated)
  - Status indicator:
    - Empty circle = no notes yet
    - Filled/colored = at least one note exists
- **Actions:**
  - Tap a supplement → opens Product Detail View
  - "Finish & notify" button (marks survey as submitted)
  - Optional: "Save & exit" (no status change)

**C) Product Detail View** (NEW: one supplement per screen, mobile-optimized)
- **Header:**
  - "← Back to list" button
  - Horizontal segmented progress bar:
    - Each segment represents one supplement
    - Segment colored if supplement has ≥1 note
- **Body:**
  - Supplement name (title)
  - Admin context block (read-only, if present) — e.g., "2 kapsulas dienā / tējkarote"
  - Textarea with ghost scaffold placeholder:
    - "Jūtams efekts? Slikta reakcija? Cik ilgi lieto? Cik daudz?"
  - **Autosave behaviors (required):**
    - On blur (user clicks away)
    - On typing (debounced, ~500ms)
    - Show "Saved ✓" feedback briefly
- **Primary CTA (context-aware):**
  - If textarea empty: "Skip and next" button
  - If textarea non-empty: "Save and next" button
- **Navigation:**
  - "Save/Skip and next" → opens next supplement (by sort_order)
  - If last supplement → returns to List View

**UI State Management:**
- **List View:**
  - Shows completion indicators (circle filled if notes exist)
  - Tapping supplement opens Product Detail View
- **Product Detail View:**
  - Autosaves draft continuously
  - "Save and next" commits note (append) and navigates
  - Progress bar shows position in survey

**Export Spec (LLM-ready deterministic format):**

When exporting a user's supplement survey:
```
Survey: "New sup survey" (ID: 3)
User: John Doe (user_id: 42)
Status: submitted
Submitted: 2025-12-18 14:32:00

Supplements:
1. Doctor's Best High Absorption CoQ10
   Context: "2 kapsulas dienā"
   Notes:
     [2025-12-15 10:00:00] (note) "Sāpēja galva pirmajās 3 dienās"
     [2025-12-17 09:30:00] (followup) "Tagad viss ok, turpinu lietot"

2. California Gold Nutrition Creatine
   Context: "tējkarote dienā"
   Notes:
     [2025-12-15 10:05:00] (note) "Negaršīgs, bet efektīvs"

3. Magnesium
   Context: null
   Notes: (none)
```

**Implementation Notes / Non-goals:**
- No strict validation for dose units (allow "2 kapsulas / tējkarote / sauja")
- No rating scales (pure free-form text)
- No inline editing in list view (mobile-first: use Product Detail View)
- Missing notes ≠ no effect (export must not assume)

**Key Files (V2 implementation):**
- [assets/js/supplement-feedback.js](assets/js/supplement-feedback.js) - Replace inline editor with list+detail flow; add autosave
- [includes/class-portal-ajax.php](includes/class-portal-ajax.php) - Add `cp_add_supplement_note`, `cp_submit_supplement_survey` endpoints
- [includes/class-portal-database.php](includes/class-portal-database.php) - Add notes insert/select helpers; optional V1→V2 migration
- DB migration script - Create `wp_cp_survey_supplement_notes` table; add `admin_context` to supplements; migrate V1 comments

#### Survey Assignment System
**Unified dropdown:** Both survey types appear in the same "Assign Survey" dropdown in admin panel

**Survey ID format:**
- Wizard surveys: String IDs like `"liver_health_short"`
- Supplement surveys: Prefixed with `"supplement_"` + database ID (e.g., `"supplement_3"`)

**Assignment table fields:**
- `user_id` - Foreign key to wp_customer_portal_users
- `survey_id` - Can be wizard ID or "supplement_N" format
- `status` - 'assigned', 'completed', etc.
- `created_at`, `updated_at`

**Client-side routing:**
When user clicks "Start Survey", [surveys.js:62-71](assets/js/surveys.js#L62-L71) checks:
- If `survey_id.indexOf('supplement_') === 0` → Load supplement survey UI
- Otherwise → Load wizard survey UI

#### Common Features
- Both types show in unified Surveys tab (no separate sections)
- Both use same card layout (survey name, status badge, Start Survey button)
- Status tracking: "Not Started" vs "Completed"
- Last completed date shown for wizard surveys
- Admin can assign/remove both types from user assignments page

## Development Workflow

### Making Changes
1. **Always work on `test` branch first**
2. Push to test → auto-deploys to fons.lv
3. Test thoroughly on fons.lv
4. Merge test → main → auto-deploys to deffo.pro

### Testing Checklist
- [ ] Telegram authentication works (test bot on fons.lv)
- [ ] User CRUD operations function
- [ ] Google Calendar integration works
- [ ] Survey functionality works
- [ ] Admin settings page displays correctly
- [ ] No console errors in browser
- [ ] No PHP errors in WordPress debug log

### Important Notes
- **Never commit wp-config.php** (already in .gitignore)
- **Never commit .env files** (if created in future)
- **Telegram bot tokens are sensitive** - keep in wp-config.php only
- **Same code, different configs** - Environment differences handled by wp-config.php

## Common Tasks

### Adding a New Feature
1. Develop on test branch
2. Test on fons.lv with test Telegram bot
3. Merge to main
4. Verify on deffo.pro with production Telegram bot

### Updating Telegram Bot (Per Environment)
1. SSH or File Manager on the specific site
2. Edit wp-config.php
3. Update `CP_TELEGRAM_BOT_TOKEN` or `CP_TELEGRAM_BOT_USERNAME`
4. Save file (no code deployment needed)

### Updating Google OAuth Credentials
**When needed:** Before deploying to production, if tokens expired, or when changing Google accounts

1. Go to WordPress Admin → Customer Portal → Settings
2. Scroll to "Google Drive API" section
3. Update the three fields:
   - Client ID (from Desktop app in Google Console)
   - Client Secret (from Desktop app in Google Console)
   - Refresh Token (from `google-auth-helper.html`)
4. Click "Save Settings"
5. Test by booking a calendar appointment

**Important:** Remember to publish OAuth app to Production in Google Console to avoid 7-day token expiration!

### Debugging
- Check browser console for JavaScript errors
- Check WordPress debug.log for PHP errors
- Verify Telegram bot token is correct for environment
- Check GitHub Actions logs for deployment issues

## Security Considerations
- Telegram bot tokens in wp-config.php (not database)
- HMAC signature validation for Telegram auth
- Nonce verification for AJAX requests
- Input sanitization with `sanitize_text_field()`
- SQL injection prevention with `$wpdb->prepare()`
- Hash timing-safe comparison with `hash_equals()`

## Future Enhancements
(To be added as development continues)
