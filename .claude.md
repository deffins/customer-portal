# Customer Portal WordPress Plugin - Development Guide

## Project Overview
WordPress plugin for customer portal management with Telegram authentication, Google Calendar/Drive integration, and survey functionality.

**Repository:** c:\projects\customer-portal\
**Production Site:** deffo.pro (main branch)
**Test Site:** fons.lv (test branch)

## Environment Setup

### Two-Environment Architecture
This project uses a two-site setup with separate domains:

| Environment | Domain | Git Branch | Deploy Target |
|-------------|--------|------------|---------------|
| **Production** | deffo.pro | `main` | `/domains/deffo.pro/public_html/wp-content/plugins/customer-portal/` |
| **Test** | fons.lv | `test` | `/domains/fons.lv/public_html/wp-content/plugins/customer-portal/` |

### Key Characteristics
- **Separate WordPress installations** - Each domain has its own WP install and database
- **Separate databases** - No shared data between environments
- **Branch-based deployment** - GitHub Actions auto-deploy on push
- **Environment-specific configs** - Telegram bots differ per environment via wp-config.php constants

### Deployment Workflow
```
Push to test branch → GitHub Actions → FTP to fons.lv
     ↓
  Test & verify
     ↓
Merge test → main → GitHub Actions → FTP to deffo.pro
```

## Configuration Management

### Telegram Bot Configuration (Environment-Specific)
**Storage:** wp-config.php constants (one for each environment, NOT in git)

**Production (deffo.pro):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'production-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'prod_bot_username');
```

**Test (fons.lv):**
```php
define('CP_TELEGRAM_BOT_TOKEN', 'test-bot-token');
define('CP_TELEGRAM_BOT_USERNAME', 'test_bot_username');
```

**Fallback:** If constants not defined, plugin uses WordPress options table (`cp_telegram_bot_token`, `cp_telegram_bot_username`)

**Why this works:**
- wp-config.php is NOT in git (each site has its own)
- Same plugin code on both sites
- Each site reads its own wp-config.php constants
- Pushing test → main does NOT affect bot configuration

### Google Calendar/Drive Configuration
**Storage:** WordPress options table only (no environment differentiation needed)

- `cp_google_client_id`
- `cp_google_client_secret`
- `cp_google_refresh_token`

**Current Setup:**
- **OAuth App:** "Customer Portal Helper" (Desktop app) in Google Cloud Console
- **Test Environment (fons.lv):** Credentials configured and working
- **Production Environment (deffo.pro):** Needs credentials update when deploying to production

**Important for OAuth App Longevity:**
1. **Publish OAuth app to Production mode** (not "Testing") to prevent refresh token expiration after 7 days
2. Go to: [OAuth Consent Screen](https://console.cloud.google.com/apis/credentials/consent)
3. If status shows "Testing" → Click "PUBLISH APP"
4. In Production mode, refresh tokens never expire unless manually revoked

**OAuth App Details:**
- **Type:** Desktop app (not Web app)
- **Name:** Customer Portal Helper
- **Redirect URI:** `http://localhost`
- **Scopes:** Calendar, Calendar Events, Drive (read-only)

**Getting a New Refresh Token:**
- Use `google-auth-helper.html` in project root
- Desktop app credentials work with `http://localhost` redirect
- Old `urn:ietf:wg:oauth:2.0:oob` redirect is deprecated and will fail
- Delete helper files after getting token (they contain credentials)

## Plugin Architecture

### Core Files
```
customer-portal/
├── customer-portal.php          # Main plugin file, registers hooks
├── includes/
│   ├── class-portal-database.php    # Database schema, table creation
│   ├── class-portal-admin.php       # Admin settings page
│   ├── class-portal-ajax.php        # AJAX handlers (Telegram auth, user CRUD)
│   ├── class-portal-frontend.php    # Frontend shortcode [customer_portal]
│   └── class-portal-surveys.php     # Survey functionality
├── assets/
│   ├── js/
│   │   ├── portal.js            # Main frontend JS (Telegram widget, user list)
│   │   ├── calendar.js          # Google Calendar integration
│   │   └── surveys.js           # Survey UI
│   └── css/
│       └── portal.css           # Frontend styles
├── .github/workflows/
│   ├── deploy.yml               # Auto-deploy main → deffo.pro
│   └── deploy-test.yml          # Auto-deploy test → fons.lv
└── docs/
    ├── TWO-DOMAIN-SETUP.md      # Environment setup guide
    ├── DEPLOYMENT.md            # FTP deployment instructions
    └── TROUBLESHOOTING.md       # Common issues
```

### Database Schema

**Table:** `wp_customer_portal_users`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, unique) - Primary user identifier
- first_name (varchar 255)
- last_name (varchar 255)
- username (varchar 255)
- email (varchar 255)
- drive_folder_id (varchar 255) - Google Drive folder for user
- is_active (tinyint) - User status
- created_at (datetime)
```

**Table:** `wp_customer_portal_surveys`
```sql
- id (mediumint, auto increment, primary key)
- telegram_id (bigint, foreign key to users)
- survey_data (longtext, JSON)
- created_at (datetime)
- updated_at (datetime)
```

### Authentication Flow

1. User visits customer portal page (shortcode `[customer_portal]`)
2. Telegram Login Widget displays (uses `cp_telegram_bot_username`)
3. User authenticates via Telegram
4. Telegram sends auth data to frontend
5. Frontend AJAX call to `verify_telegram_auth` action
6. Backend validates HMAC signature using `cp_telegram_bot_token`
7. User created/updated in database (by `telegram_id`)
8. Session established, user list loads

**Key Files:**
- [includes/class-portal-frontend.php:70](c:\projects\customer-portal\includes\class-portal-frontend.php#L70) - Passes bot username to JS
- [includes/class-portal-ajax.php:57-133](c:\projects\customer-portal\includes\class-portal-ajax.php#L57-L133) - HMAC validation logic

### Google Integration Flow

**Google Calendar:**
1. Admin configures Google credentials in settings
2. Users can book appointments via calendar.js
3. Events created in Google Calendar with Meet links
4. Calendar invites sent to customer email

**Google Drive:**
1. Each user gets a dedicated Drive folder (`drive_folder_id`)
2. Folder created on first access
3. Used for storing customer documents

### Survey System Architecture

The plugin supports two types of surveys with different purposes and workflows:

#### 1. Wizard Surveys (JSON-based, hardcoded)
**Purpose:** Multi-question surveys with scoring and dimension analysis (e.g., liver health assessment)

**Storage:**
- Survey definitions: Hardcoded in PHP (see `cp_get_survey_definition` in class-portal-ajax.php)
- User results: `wp_cp_survey_results` table
- Assignments: `wp_cp_survey_assignments` table

**Structure:**
```json
{
  "id": "liver_health_short",
  "title": "Aknu veselības anketa (īsa versija)",
  "description": "Īsa anketa par aknu, žults, gremošanas un stresa simptomiem.",
  "questions": [
    {
      "id": "q1",
      "label": "Question text",
      "type": "slider|single_choice|text",
      "min": 0, "max": 10,  // for slider
      "options": [...],      // for single_choice
      "dimension": "liver|bile|digestion|stress"
    }
  ]
}
```

**Workflow:**
1. Admin assigns survey to user via Assignments dropdown
2. User sees survey card in Surveys tab with "Start Survey" button
3. Survey opens in wizard mode (one question at a time)
4. Progress bar shows completion percentage
5. Answers stored in JSON format with dimension scores
6. Survey can be retaken (completion_count tracked)

**Key Files:**
- [includes/class-portal-ajax.php:400-535](includes/class-portal-ajax.php#L400-L535) - Survey definitions and AJAX handlers
- [assets/js/surveys.js](assets/js/surveys.js) - Wizard UI rendering
- [includes/class-portal-database.php:669-735](includes/class-portal-database.php#L669-L735) - Assignment methods

#### 2. Supplement Feedback Surveys (Database-driven, dynamic)
**Purpose:** Collect client feedback on specific supplements

**Storage Architecture:**

The supplement survey system uses a normalized database structure with three core tables:

1. **Survey Metadata** (`wp_cp_surveys`)
   - Stores survey header information
   - Fields: `id`, `title`, `type` (always 'supplement_feedback'), `created_at`, `updated_at`
   - One record per survey (e.g., "New sup survey")

2. **Supplements List** (`wp_cp_survey_supplements`)
   - Stores the list of supplements for each survey
   - Fields: `id`, `survey_id` (FK), `name` (supplement name), `sort_order`
   - Multiple records per survey (one per supplement)
   - Example: survey_id=3 might have supplements: "Doctor's Best High Absorption CoQ10", "California Gold Nutrition Creatine Monohydrate"

3. **User Comments** (`wp_cp_survey_supplement_comments`)
   - Stores individual user feedback for each supplement
   - Fields: `id`, `survey_id`, `supplement_id` (FK), `user_id` (FK), `comment_text`, `created_at`, `updated_at`
   - Constraint: `UNIQUE KEY user_supplement (user_id, supplement_id)` - ensures one comment per user per supplement
   - Comments are stored independently - user can save/edit/delete comments for individual supplements without affecting others

4. **Survey Assignments** (`wp_cp_survey_assignments`)
   - Links surveys to users
   - Fields: `user_id`, `survey_id` (format: "supplement_3"), `status`, `created_at`, `updated_at`
   - Shared table with wizard surveys

**Database Schema:**
```sql
wp_cp_surveys:
- id (PK)
- title (varchar 255)
- type ('supplement_feedback')
- created_at, updated_at

wp_cp_survey_supplements:
- id (PK)
- survey_id (FK → wp_cp_surveys.id)
- name (varchar 255, supplement name)
- sort_order (int, display order)

wp_cp_survey_supplement_comments:
- id (PK)
- survey_id (int, denormalized for query performance)
- supplement_id (FK → wp_cp_survey_supplements.id)
- user_id (FK → wp_customer_portal_users.id)
- comment_text (text, nullable)
- created_at, updated_at
- UNIQUE KEY user_supplement (user_id, supplement_id)

wp_cp_survey_assignments:
- id (PK)
- user_id (FK → wp_customer_portal_users.id)
- survey_id (varchar 100, format: "supplement_3")
- status (varchar 50, 'assigned'/'completed')
- created_at, updated_at
- UNIQUE KEY user_survey (user_id, survey_id)
```

**Data Flow & Write Operations:**

1. **Admin Creates Survey**
   - Admin panel: "Supplement Feedback Surveys" section
   - Admin enters survey title (e.g., "New sup survey")
   - Admin adds supplements (e.g., "Magnesium", "Vitamin D", "CoQ10")
   - **Database writes:**
     - INSERT into `wp_cp_surveys` (title, type='supplement_feedback')
     - Multiple INSERTs into `wp_cp_survey_supplements` (survey_id, name, sort_order)

2. **Admin Assigns Survey to User**
   - Admin selects user and survey from Assignments dropdown
   - Survey appears as "supplement_3" in dropdown (prefix + database ID)
   - **Database write:**
     - INSERT into `wp_cp_survey_assignments` (user_id, survey_id='supplement_3', status='assigned')

3. **Client Adds Comment**
   - Client clicks "Add comment" button on a supplement
   - Enters text in textarea
   - Clicks "Save"
   - **AJAX call:** `cp_save_supplement_comment` (survey_id, supplement_id, telegram_id, comment_text)
   - **Database write:**
     - INSERT into `wp_cp_survey_supplement_comments` (survey_id, supplement_id, user_id, comment_text)
     - Note: telegram_id is converted to database user_id server-side

4. **Client Edits Comment**
   - Client clicks "Edit comment" button
   - Modifies text in textarea
   - Clicks "Save"
   - **AJAX call:** `cp_save_supplement_comment` (same parameters)
   - **Database write:**
     - UPDATE `wp_cp_survey_supplement_comments` SET comment_text='...' WHERE user_id=X AND supplement_id=Y
     - Uses UNIQUE constraint to find existing record

5. **Client Deletes Comment**
   - Client clicks "Edit comment", clears all text
   - Clicks "Save" (empty textarea)
   - **AJAX call:** `cp_delete_supplement_comment` (survey_id, supplement_id, telegram_id)
   - **Database write:**
     - DELETE FROM `wp_cp_survey_supplement_comments` WHERE user_id=X AND supplement_id=Y

**Client-Side UI Design & Behavior:**

**Survey List View:**
- All assigned surveys displayed as cards in unified "Surveys" tab
- Card layout: `[Survey Name] [Status Badge] [Start Survey Button]`
- Supplement surveys mixed with wizard surveys (no visual distinction)
- Example card: "New sup survey" | "Not Started" | [Start Survey]

**Survey Detail View:**
```
← Back to Surveys

New sup survey
Add your feedback for each supplement:

┌─────────────────────────────────────────────────┐
│ Doctor's Best High Absorption CoQ10            │
│                           [Add comment] button  │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ California Gold Nutrition Creatine Monohydrate  │
│ Sāpēja galva un bija negaršīgs, lauza          │ ← Existing comment displayed
│ kaulus jo nelietoju                             │
│                          [Edit comment] button  │
└─────────────────────────────────────────────────┘
```

**Comment Editor UI (when clicking Add/Edit):**
- Textarea appears inline (replaces comment display if editing)
- Two action buttons: [Save] [Cancel]
- On save: AJAX request → Success notification → UI updates
- On cancel: Textarea hidden, original comment re-displayed (if exists)

**UI State Management:**
- **No comment exists:** "Add comment" button (primary style, orange)
- **Comment exists:** "Edit comment" button + comment text displayed below supplement name
- **Editing mode:** Textarea with [Save] [Cancel] buttons, comment display hidden
- **After save:** Editor hidden, updated comment displayed, button changes to "Edit comment"
- **After delete (empty save):** Editor hidden, comment removed, button changes back to "Add comment"

**Real-time Validation:**
- No validation on comment length (can be empty for deletion)
- Save button disabled during AJAX request (shows "Saving...")
- Success/error notifications appear in top-right corner (green notification, auto-fade after 3s)

**Workflow:**
1. Admin creates survey in "Supplement Feedback Surveys" section
2. Admin adds supplements to survey (e.g., "Magnesium", "Vitamin D")
3. Admin assigns survey to user via Assignments dropdown (shows as "supplement_N")
4. User sees survey card in Surveys tab with orange "Start Survey" button
5. User clicks "Start Survey" → Survey detail view loads (all supplements shown at once)
6. Each supplement has inline "Add comment" or "Edit comment" button
7. User can add/edit/delete feedback for each supplement independently
8. Comments auto-saved individually via AJAX (no "submit all" button)
9. User can click "← Back to Surveys" anytime to return to list view

**Key Files:**
- [includes/class-portal-admin.php:1099-1280](includes/class-portal-admin.php#L1099-L1280) - Admin UI for creating surveys
- [includes/class-portal-database.php:846-1046](includes/class-portal-database.php#L846-L1046) - Database operations
- [includes/class-portal-ajax.php:872-1003](includes/class-portal-ajax.php#L872-L1003) - AJAX handlers
- [assets/js/supplement-feedback.js](assets/js/supplement-feedback.js) - Client-side UI

#### Survey Assignment System
**Unified dropdown:** Both survey types appear in the same "Assign Survey" dropdown in admin panel

**Survey ID format:**
- Wizard surveys: String IDs like `"liver_health_short"`
- Supplement surveys: Prefixed with `"supplement_"` + database ID (e.g., `"supplement_3"`)

**Assignment table fields:**
- `user_id` - Foreign key to wp_customer_portal_users
- `survey_id` - Can be wizard ID or "supplement_N" format
- `status` - 'assigned', 'completed', etc.
- `created_at`, `updated_at`

**Client-side routing:**
When user clicks "Start Survey", [surveys.js:62-71](assets/js/surveys.js#L62-L71) checks:
- If `survey_id.indexOf('supplement_') === 0` → Load supplement survey UI
- Otherwise → Load wizard survey UI

#### Common Features
- Both types show in unified Surveys tab (no separate sections)
- Both use same card layout (survey name, status badge, Start Survey button)
- Status tracking: "Not Started" vs "Completed"
- Last completed date shown for wizard surveys
- Admin can assign/remove both types from user assignments page

## Development Workflow

### Making Changes
1. **Always work on `test` branch first**
2. Push to test → auto-deploys to fons.lv
3. Test thoroughly on fons.lv
4. Merge test → main → auto-deploys to deffo.pro

### Testing Checklist
- [ ] Telegram authentication works (test bot on fons.lv)
- [ ] User CRUD operations function
- [ ] Google Calendar integration works
- [ ] Survey functionality works
- [ ] Admin settings page displays correctly
- [ ] No console errors in browser
- [ ] No PHP errors in WordPress debug log

### Important Notes
- **Never commit wp-config.php** (already in .gitignore)
- **Never commit .env files** (if created in future)
- **Telegram bot tokens are sensitive** - keep in wp-config.php only
- **Same code, different configs** - Environment differences handled by wp-config.php

## Common Tasks

### Adding a New Feature
1. Develop on test branch
2. Test on fons.lv with test Telegram bot
3. Merge to main
4. Verify on deffo.pro with production Telegram bot

### Updating Telegram Bot (Per Environment)
1. SSH or File Manager on the specific site
2. Edit wp-config.php
3. Update `CP_TELEGRAM_BOT_TOKEN` or `CP_TELEGRAM_BOT_USERNAME`
4. Save file (no code deployment needed)

### Updating Google OAuth Credentials
**When needed:** Before deploying to production, if tokens expired, or when changing Google accounts

1. Go to WordPress Admin → Customer Portal → Settings
2. Scroll to "Google Drive API" section
3. Update the three fields:
   - Client ID (from Desktop app in Google Console)
   - Client Secret (from Desktop app in Google Console)
   - Refresh Token (from `google-auth-helper.html`)
4. Click "Save Settings"
5. Test by booking a calendar appointment

**Important:** Remember to publish OAuth app to Production in Google Console to avoid 7-day token expiration!

### Debugging
- Check browser console for JavaScript errors
- Check WordPress debug.log for PHP errors
- Verify Telegram bot token is correct for environment
- Check GitHub Actions logs for deployment issues

## Security Considerations
- Telegram bot tokens in wp-config.php (not database)
- HMAC signature validation for Telegram auth
- Nonce verification for AJAX requests
- Input sanitization with `sanitize_text_field()`
- SQL injection prevention with `$wpdb->prepare()`
- Hash timing-safe comparison with `hash_equals()`

## Future Enhancements
(To be added as development continues)
